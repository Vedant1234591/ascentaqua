<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - AscentAqua</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <%- include('../../partials/header', { cartCount: cartCount }) %>
    
    <main>
        <section class="admin-products">
            <div class="container">
                <div class="admin-header">
                    <h1>Manage Products</h1>
                    <div class="admin-nav">
                        <a href="/admin" class="nav-link">Dashboard</a>
                        <a href="/admin/products" class="nav-link active">Products</a>
                        <a href="/admin/orders" class="nav-link">Orders</a>
                        <a href="/" class="nav-link">View Site</a>
                    </div>
                </div>

                <div class="products-actions">
                    <a href="/admin/products/create" class="cta-button">
                        <i class="fas fa-plus"></i> Add New Product
                    </a>
                </div>

                <!-- Products Grid -->
                <div class="products-grid-admin">
                    <% if (products.length > 0) { %>
                        <% products.forEach(product => { %>
                            <div class="product-card-admin">
                                <div class="product-image-admin">
                                    <i class="fas fa-wine-bottle"></i>
                                </div>
                                <div class="product-info-admin">
                                    <h3><%= product.name %></h3>
                                    <p class="product-description"><%= product.description %></p>
                                    <div class="product-specs">
                                        <span><strong>Capacity:</strong> <%= product.capacity %></span>
                                        <span><strong>Price:</strong> $<%= product.price.toFixed(2) %></span>
                                        <span class="stock <%= product.inStock ? 'in-stock' : 'out-of-stock' %>">
                                            <%= product.inStock ? 'In Stock' : 'Out of Stock' %>
                                        </span>
                                    </div>
                                </div>
                                <div class="product-actions">
                                    <a href="/admin/products/<%= product._id %>/edit" class="btn-edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <button class="btn-delete" onclick="deleteProduct('<%= product._id %>')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="no-products">
                            <i class="fas fa-box-open"></i>
                            <h3>No Products Found</h3>
                            <p>Get started by creating your first product.</p>
                            <a href="/admin/products/create" class="cta-button">Create Product</a>
                        </div>
                    <% } %>
                </div>
            </div>
        </section>
    </main>

    <%- include('../../partials/footer') %>
    
    <script>
    async function deleteProduct(productId) {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
            try {
                console.log('Deleting product with ID:', productId);
                
                const response = await fetch(`/admin/products/${productId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include' // Important for sessions/cookies
                });

                const result = await response.json();
                console.log('Delete response:', result);

                if (result.success) {
                    alert('Product deleted successfully!');
                    // Remove the product card from UI or reload the page
                    location.reload(); // Simple solution - reload the page
                    // Alternatively, you can remove the specific product card without reloading:
                    // const productCard = document.querySelector(`[data-product-id="${productId}"]`);
                    // if (productCard) productCard.remove();
                } else {
                    alert('Failed to delete product: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product. Please try again.');
            }
        }
    }
</script>
</body>
</html>